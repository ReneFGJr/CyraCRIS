<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi‑API JSON BrCRIS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0b1020; }
    .card-body { color: #eeeeff; }
    .navbar, .card { border-radius: 1rem; }
    .brand-grad {
      background: linear-gradient(120deg, #6ea8fe, #d63384);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    pre { background: #0f172a; color: #e2e8f0; padding: 1rem; border-radius: .75rem; overflow:auto; }
    code { white-space: pre-wrap; }
    .form-floating > .form-control::placeholder { color: transparent; }
    .header-row input { min-width: 160px; }
    .status-badge { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="text-light">
  <nav class="navbar navbar-dark bg-dark bg-opacity-75 my-3 mx-2 px-3 shadow-sm">
    <span class="navbar-brand mb-0 h1"><span class="brand-grad">Multi‑API JSON BrCRIS</span></span>
    <div class="text-secondary small">Bootstrap + Fetch</div>
  </nav>

  <main class="container pb-5">
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm bg-dark bg-opacity-50">
          <div class="card-body">
            <h5 class="card-title mb-3">Configurar requisições</h5>

            <div class="mb-3">
              <label for="urls" class="form-label">Endpoint (URL)</label>
              <textarea id="urls" class="form-control" rows="3" placeholder="http://200.130.0.48/200.130.0.48"></textarea>
            </div>

            <div class="row g-2 align-items-end mb-3">
              <div class="col-6">
                <label for="method" class="form-label">Método</label>
                <select id="method" class="form-select">
                  <option>GET</option>
                  <option>POST</option>
                  <option>PUT</option>
                  <option>PATCH</option>
                  <option>DELETE</option>
                  <option>HEAD</option>
                  <option>OPTIONS</option>
                </select>
              </div>
              <div class="col-6">
                <label for="timeout" class="form-label">Timeout por requisição (s)</label>
                <input id="timeout" type="number" min="1" step="1" class="form-control" value="15">
              </div>
            </div>

            <div class="mb-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <label class="form-label mb-0">Headers</label>
                <button id="addHeader" class="btn btn-sm btn-outline-light" type="button">+ Adicionar header</button>
              </div>
              <div id="headers" class="vstack gap-2"></div>
            </div>

            <div class="mb-3">
              <label for="body" class="form-label">Corpo (JSON) — usado para POST/PUT/PATCH/DELETE</label>
              <textarea id="body" class="form-control" rows="6" placeholder='{"name":"Rene"}'></textarea>
              <div class="form-text text-secondary">Deixe vazio para enviar sem corpo. O conteúdo deve ser um JSON válido.</div>
            </div>

            <div class="d-flex gap-2">
              <button id="send" class="btn btn-primary">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="btnSpinner" role="status" aria-hidden="true"></span>
                Enviar requisições
              </button>
              <button id="clear" class="btn btn-outline-light">Limpar resultados</button>
              <button id="save" class="btn btn-outline-secondary" title="Salva esta configuração no navegador">Salvar preset</button>
              <button id="load" class="btn btn-outline-secondary" title="Carrega a última configuração salva">Carregar preset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm bg-dark bg-opacity-50">
          <div class="card-body">
            <h5 class="card-title mb-3">Resultados</h5>
            <div id="results" class="vstack gap-3">
              <div class="text-secondary">Envie para ver as respostas aqui.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <template id="header-row-template">
    <div class="input-group header-row">
      <span class="input-group-text">Chave</span>
      <input type="text" class="form-control key" placeholder="Authorization" />
      <span class="input-group-text">Valor</span>
      <input type="text" class="form-control value" placeholder="Bearer &lt;token&gt;" />
      <button class="btn btn-outline-danger remove" type="button" title="Remover">&times;</button>
    </div>
  </template>

  <template id="result-template">
    <div class="card bg-black bg-opacity-50 border border-secondary">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="small text-truncate" style="max-width: 100%;">
          <span class="badge bg-info-subtle text-info-emphasis status-badge me-2 method">GET</span>
          <code class="text-light url">URL</code>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary-subtle text-secondary-emphasis status">…</span>
          <span class="badge bg-secondary-subtle text-secondary-emphasis time" title="Duração">0 ms</span>
          <button class="btn btn-sm btn-outline-light copy">Copiar JSON</button>
          <button class="btn btn-sm btn-outline-light download">Baixar</button>
          <button class="btn btn-sm btn-outline-secondary toggle">Headers</button>
        </div>
      </div>
      <div class="card-body">
        <div class="collapse headers mb-3"></div>
        <pre class="mb-0"><code class="payload">{}</code></pre>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    const urlsEl = qs('#urls');
    const methodEl = qs('#method');
    const timeoutEl = qs('#timeout');
    const headersEl = qs('#headers');
    const bodyEl = qs('#body');
    const sendBtn = qs('#send');
    const spinner = qs('#btnSpinner');
    const clearBtn = qs('#clear');
    const addHeaderBtn = qs('#addHeader');
    const saveBtn = qs('#save');
    const loadBtn = qs('#load');
    const resultsEl = qs('#results');

    function addHeaderRow(key = '', value = '') {
      const tpl = qs('#header-row-template');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('.key').value = key;
      node.querySelector('.value').value = value;
      node.querySelector('.remove').addEventListener('click', () => node.remove());
      headersEl.appendChild(node);
    }

    function readHeaders() {
      const rows = qsa('#headers .header-row');
      const headers = {};
      for (const row of rows) {
        const k = row.querySelector('.key').value.trim();
        const v = row.querySelector('.value').value;
        if (k) headers[k] = v;
      }
      return headers;
    }

    function pretty(obj) {
      try {
        return JSON.stringify(obj, null, 2);
      } catch (e) {
        return String(obj);
      }
    }

    function makeResultCard({ url, method }) {
      const tpl = qs('#result-template');
      const card = tpl.content.firstElementChild.cloneNode(true);
      card.querySelector('.url').textContent = url;
      card.querySelector('.method').textContent = method;

      card.querySelector('.toggle').addEventListener('click', () => {
        const el = card.querySelector('.headers');
        new bootstrap.Collapse(el, { toggle: true });
      });

      card.querySelector('.copy').addEventListener('click', async () => {
        const text = card.querySelector('.payload').textContent;
        try { await navigator.clipboard.writeText(text); toast('JSON copiado.'); }
        catch { toast('Falha ao copiar.'); }
      });

      card.querySelector('.download').addEventListener('click', () => {
        const blob = new Blob([card.querySelector('.payload').textContent], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'response.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      resultsEl.prepend(card);
      return card;
    }

    function setStatus(card, status, durationMs) {
      const badge = card.querySelector('.status');
      badge.textContent = status;
      badge.classList.remove('bg-secondary-subtle', 'text-secondary-emphasis', 'bg-success-subtle', 'text-success-emphasis', 'bg-danger-subtle', 'text-danger-emphasis', 'bg-warning-subtle', 'text-warning-emphasis');

      if (status >= 200 && status < 300) {
        badge.classList.add('bg-success-subtle', 'text-success-emphasis');
      } else if (status >= 400) {
        badge.classList.add('bg-danger-subtle', 'text-danger-emphasis');
      } else {
        badge.classList.add('bg-warning-subtle', 'text-warning-emphasis');
      }
      card.querySelector('.time').textContent = `${durationMs} ms`;
    }

    function showHeaders(card, headers) {
      const container = card.querySelector('.headers');
      const lines = [];
      for (const [k, v] of headers.entries()) {
        lines.push(`<div><code>${escapeHtml(k)}</code>: <code>${escapeHtml(v)}</code></div>`);
      }
      container.innerHTML = lines.join('') || '<div class="text-secondary">(sem headers)</div>';
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3';
      el.setAttribute('role', 'alert');
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${escapeHtml(msg)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
      document.body.appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2500 });
      el.addEventListener('hidden.bs.toast', () => el.remove());
      t.show();
    }

    async function sendRequests() {
      const urls = urlsEl.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (urls.length === 0) { toast('Informe pelo menos uma URL.'); return; }

      const method = methodEl.value.toUpperCase();
      const headers = readHeaders();
      const timeoutSec = Math.max(1, parseInt(timeoutEl.value || '15', 10));
      let body = bodyEl.value.trim();

      let parsedBody = undefined;
      if (body && !['GET', 'HEAD', 'OPTIONS'].includes(method)) {
        try { parsedBody = JSON.parse(body); }
        catch (e) { toast('JSON do corpo inválido.'); return; }
      }

      sendBtn.disabled = true; spinner.classList.remove('d-none');

      const promises = urls.map(async (url) => {
        const card = makeResultCard({ url, method });
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort('timeout'), timeoutSec * 1000);
        const started = performance.now();

        try {
          const res = await fetch(url, {
            method,
            headers: {
              ...(Object.keys(headers).length ? headers : {}),
              ...(parsedBody ? { 'Content-Type': 'application/json' } : {}),
            },
            body: parsedBody ? JSON.stringify(parsedBody) : undefined,
            signal: controller.signal,
            cache: 'no-store',
          });
          const duration = Math.max(1, Math.round(performance.now() - started));
          setStatus(card, res.status, duration);
          showHeaders(card, res.headers);

          const ct = res.headers.get('content-type') || '';
          let payloadText = '';
          if (ct.includes('application/json')) {
            const data = await res.json().catch(() => ({}));
            payloadText = pretty(data);
          } else {
            const text = await res.text();
            payloadText = text;
          }
          card.querySelector('.payload').textContent = payloadText;
        } catch (err) {
          const duration = Math.max(1, Math.round(performance.now() - started));
          card.querySelector('.payload').textContent = String(err);
          setStatus(card, 0, duration);
          showHeaders(card, new Headers());
        } finally {
          clearTimeout(timer);
        }
      });

      await Promise.allSettled(promises);
      spinner.classList.add('d-none');
      sendBtn.disabled = false;
    }

    function clearResults() {
      resultsEl.innerHTML = '<div class="text-secondary">Resultados limpos.</div>';
    }

    function savePreset() {
      const rows = qsa('#headers .header-row').map(r => ({
        key: r.querySelector('.key').value,
        value: r.querySelector('.value').value,
      }));
      const preset = {
        urls: urlsEl.value,
        method: methodEl.value,
        timeout: timeoutEl.value,
        headers: rows,
        body: bodyEl.value,
      };
      localStorage.setItem('multiApiTesterPreset', JSON.stringify(preset));
      toast('Preset salvo.');
    }

    function loadPreset() {
      const raw = localStorage.getItem('multiApiTesterPreset');
      if (!raw) { toast('Nenhum preset salvo.'); return; }
      const p = JSON.parse(raw);
      urlsEl.value = p.urls || '';
      methodEl.value = p.method || 'GET';
      timeoutEl.value = p.timeout || '15';
      headersEl.innerHTML = '';
      (p.headers || []).forEach(h => addHeaderRow(h.key, h.value));
      bodyEl.value = p.body || '';
      toast('Preset carregado.');
    }

    // Events
    addHeaderBtn.addEventListener('click', () => addHeaderRow());
    sendBtn.addEventListener('click', sendRequests);
    clearBtn.addEventListener('click', clearResults);
    saveBtn.addEventListener('click', savePreset);
    loadBtn.addEventListener('click', loadPreset);

    // Defaults
    addHeaderRow('Accept', 'application/json');
    urlsEl.value = 'http://200.130.0.48/orgunit/search?q=UNIVERSIDADE%20FEDERAL%20DO%20RIO%20GRANDE%20DO%20SUL\nhttp://200.130.0.48/orgunit/id/3138';
  </script>
</body>
</html>
